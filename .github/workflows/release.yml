name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Setup Environment (Deps & Tools)
      run: |
        chmod +x ./tools/setup_go_env.sh
        ./tools/setup_go_env.sh
        # Add GOPATH/bin to PATH for subsequent steps (to find 'fyne')
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install Inno Setup
      uses: minijazz/inno-setup-action@v1.0.1
      # On Linux, this sets up Wine and ISCC

    - name: Build Binary
      run: |
        chmod +x ./tools/build.sh
        ./tools/build.sh

    - name: Update Distro List
      run: |
        SHELL=pwsh pwsh ./scripts/update_distros.ps1
      shell: bash

    - name: Package (Zip and Installer)
      run: |
        chmod +x ./tools/packaging/package.sh
        # Pass the tag version (remove 'v' prefix)
        VERSION=${GITHUB_REF#refs/tags/v}
        ./tools/packaging/package.sh $VERSION

    # Code Signing Step (Start)
    # This step requires setting up SignPath project and secrets
    # Uncomment and configure when ready
    # - name: Sign with SignPath
    #   uses: signpath/github-action@v1
    #   with:
    #     api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
    #     signing-policy-slug: release-signing
    #     artifact-file: release/DistroNexus_Setup_*.exe
    #     output-artifact-file: release/DistroNexus_Setup_Signed.exe
    # Code Signing Step (End)

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        body_path: docs/release_notes/${{ github.ref_name }}.md
        files: |
          release/*.zip
          release/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
